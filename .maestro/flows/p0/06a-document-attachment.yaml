# P0 E2E: Document Attachment Flow
# Tests attaching a document to a chat message and sending it
# Prerequisites: Text model must be loaded
#
# Strategy:
# 1. Open chat
# 2. Tap document picker button
# 3. Verify picker opens (native file picker)
# 4. Cancel picker (we can't select files in Maestro native pickers reliably)
# 5. Verify chat input is still usable after picker dismissal

appId: ai.offgridmobile
name: "P0: Document Attachment"
tags:
  - p0
  - attachment
  - document
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# ==============================
# Handle onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('DOC_ATTACH - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('DOC_ATTACH - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('DOC_ATTACH - On home')}"

# ==============================
# Ensure model is loaded
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - evalScript: "${console.log('DOC_ATTACH - Load model')}"
      - runFlow: 00-setup-model.yaml

- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# ==============================
# Open chat
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Open chat')}"
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000
- takeScreenshot: 01-chat-screen

# ==============================
# Test: Document picker button exists
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Verify document picker button')}"
- assertVisible:
    id: "document-picker-button"
- takeScreenshot: 02-picker-button-visible

# ==============================
# Test: Tap document picker
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Tap document picker')}"
- tapOn:
    id: "document-picker-button"

# Native file picker opens - wait briefly then dismiss
# On Android, back dismisses the picker; on iOS, cancel button
- evalScript: "${console.log('DOC_ATTACH - Dismiss native picker')}"
- back
- takeScreenshot: 03-after-picker-dismiss

# ==============================
# Verify chat is still functional after picker dismissal
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Verify chat still functional')}"
- extendedWaitUntil:
    visible:
      id: "chat-input"
    timeout: 5000

# Type and send a message to verify chat works
- tapOn:
    id: "chat-input"
- inputText: "Hello"
- hideKeyboard

- assertVisible:
    id: "send-button"
- takeScreenshot: 04-chat-functional

# ==============================
# Verify send works after picker interaction
# ==============================
- evalScript: "${console.log('DOC_ATTACH - Send message')}"
- tapOn:
    id: "send-button"

- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000

- evalScript: "${console.log('DOC_ATTACH - PASSED')}"
- takeScreenshot: 99-complete
