# P0 E2E: Image Attachment Flow
# Tests the image attachment button and camera/library picker dialog
# Prerequisites: Text model must be loaded
#
# Strategy:
# 1. Open chat
# 2. Verify camera button visibility (depends on vision support)
# 3. Tap camera button
# 4. Verify source selection dialog appears (Camera / Photo Library)
# 5. Dismiss dialog
# 6. Verify chat remains functional

appId: ai.offgridmobile
name: "P0: Image Attachment"
tags:
  - p0
  - attachment
  - image
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('IMG_ATTACH - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# ==============================
# Handle onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('IMG_ATTACH - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('IMG_ATTACH - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('IMG_ATTACH - On home')}"

# ==============================
# Ensure model is loaded
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - evalScript: "${console.log('IMG_ATTACH - Load model')}"
      - runFlow: 00-setup-model.yaml

- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# ==============================
# Open chat
# ==============================
- evalScript: "${console.log('IMG_ATTACH - Open chat')}"
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000
- takeScreenshot: 01-chat-screen

# ==============================
# Test: Camera button (vision-capable models only)
# ==============================
# Camera button only appears when model supports vision (mmProjPath)
# If camera button is visible, test the image picker flow
- runFlow:
    when:
      visible:
        id: "camera-button"
    commands:
      - evalScript: "${console.log('IMG_ATTACH - Camera button visible (vision model)')}"
      - takeScreenshot: 02-camera-button

      # Tap camera button to open source selection
      - tapOn:
          id: "camera-button"

      # Verify source selection dialog appears
      - extendedWaitUntil:
          visible:
            text: "Camera"
          timeout: 5000
      - evalScript: "${console.log('IMG_ATTACH - Source selection dialog shown')}"
      - takeScreenshot: 03-source-dialog

      # Verify both options exist
      - assertVisible:
          text: "Camera"
      - assertVisible:
          text: "Photo Library"

      # Dismiss dialog by tapping Cancel
      - tapOn:
          text: "Cancel"
      - evalScript: "${console.log('IMG_ATTACH - Dialog dismissed')}"
      - takeScreenshot: 04-dialog-dismissed

      # Verify vision indicator badge is shown
      - assertVisible:
          id: "vision-indicator"
      - evalScript: "${console.log('IMG_ATTACH - Vision indicator visible')}"

# If no camera button, model doesn't support vision - that's OK
- runFlow:
    when:
      notVisible:
        id: "camera-button"
    commands:
      - evalScript: "${console.log('IMG_ATTACH - No camera button (non-vision model), skipping image tests')}"
      - takeScreenshot: 02-no-camera-button

# ==============================
# Verify chat is still functional
# ==============================
- evalScript: "${console.log('IMG_ATTACH - Verify chat functional')}"
- tapOn:
    id: "chat-input"
- inputText: "Say OK"
- hideKeyboard

- tapOn:
    id: "send-button"

- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000

- evalScript: "${console.log('IMG_ATTACH - PASSED')}"
- takeScreenshot: 99-complete
