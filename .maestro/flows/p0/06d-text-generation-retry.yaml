# P0 E2E: Text Generation - Retry Flow
# Tests retrying a generation from the message action menu
# Prerequisites: Text model must be loaded

appId: ai.offgridmobile
name: "P0: Text Generation Retry"
tags:
  - p0
  - generation
  - text
  - retry
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('RETRY - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# ==============================
# Handle onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('RETRY - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('RETRY - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# ==============================
# Ensure model is loaded
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - runFlow: 00-setup-model.yaml

- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# ==============================
# Open chat and send initial message
# ==============================
- evalScript: "${console.log('RETRY - Open chat')}"
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000

- tapOn:
    id: "chat-input"
- inputText: "Say exactly: FIRST"
- hideKeyboard
- tapOn:
    id: "send-button"

# Wait for response
- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000
- evalScript: "${console.log('RETRY - First response received')}"
- takeScreenshot: 01-first-response

# ==============================
# Test: Retry generation
# ==============================
- evalScript: "${console.log('RETRY - Long press for action menu')}"
- longPressOn:
    id: "assistant-message"

- extendedWaitUntil:
    visible:
      id: "action-menu"
    timeout: 5000

# Tap retry
- evalScript: "${console.log('RETRY - Tap retry')}"
- tapOn:
    id: "action-retry"

# Wait for new response (retry replaces the previous assistant message)
- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000
- evalScript: "${console.log('RETRY - Retry response received')}"
- takeScreenshot: 02-retry-response

# Verify generation metadata on retried message
- assertVisible:
    id: "generation-meta"

# Verify chat input is ready
- assertVisible:
    id: "chat-input"

- evalScript: "${console.log('RETRY - PASSED')}"
- takeScreenshot: 99-complete
