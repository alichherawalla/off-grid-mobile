# P0 E2E: Text Generation - Full Flow
# Tests the complete text generation lifecycle including:
# - Sending a message and receiving a response
# - Streaming state (thinking indicator, streaming cursor)
# - Generation metadata display (tokens/sec)
# - Message actions (copy, retry)
# - Multi-turn conversation
# - Chat input queue indicator
#
# Prerequisites: Text model must be loaded

appId: ai.offgridmobile
name: "P0: Text Generation Full"
tags:
  - p0
  - generation
  - text
  - full
---

# ==============================
# Launch app
# ==============================
- evalScript: "${console.log('TEXT_GEN - Launch')}"
- launchApp

- extendedWaitUntil:
    notVisible:
      id: "app-loading"
    timeout: 30000

# ==============================
# Handle onboarding
# ==============================
- runFlow:
    when:
      visible:
        text: "Welcome to Off Grid"
    commands:
      - evalScript: "${console.log('TEXT_GEN - Skip onboarding')}"
      - tapOn:
          text: "Skip"
      - extendedWaitUntil:
          visible:
            text: "Skip for Now"
          timeout: 30000
      - tapOn:
          text: "Skip for Now"

- runFlow:
    when:
      visible:
        text: "Download Your First Model"
    commands:
      - evalScript: "${console.log('TEXT_GEN - Skip prompt')}"
      - tapOn:
          text: "Skip for Now"

# ==============================
# Wait for home screen
# ==============================
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000
- evalScript: "${console.log('TEXT_GEN - On home')}"

# ==============================
# Ensure model is loaded
# ==============================
- runFlow:
    when:
      visible:
        id: "setup-card"
    commands:
      - evalScript: "${console.log('TEXT_GEN - Load model')}"
      - runFlow: 00-setup-model.yaml

- extendedWaitUntil:
    visible:
      id: "new-chat-button"
    timeout: 5000

# ==============================
# Open new chat
# ==============================
- evalScript: "${console.log('TEXT_GEN - Open chat')}"
- tapOn:
    id: "new-chat-button"

- extendedWaitUntil:
    visible:
      id: "chat-screen"
    timeout: 10000
- takeScreenshot: 01-chat-screen

# ==============================
# Verify model selector is visible
# ==============================
- evalScript: "${console.log('TEXT_GEN - Verify model selector')}"
- assertVisible:
    id: "model-selector"
- assertVisible:
    id: "model-loaded-indicator"
- takeScreenshot: 02-model-info

# ==============================
# Test 1: Send first message and get response
# ==============================
- evalScript: "${console.log('TEXT_GEN - Send first message')}"
- tapOn:
    id: "chat-input"
- inputText: "Hello, respond with one word: OK"
- hideKeyboard

- tapOn:
    id: "send-button"

# Verify user message appears
- extendedWaitUntil:
    visible:
      id: "user-message"
    timeout: 5000
- evalScript: "${console.log('TEXT_GEN - User message shown')}"

# Wait for assistant response
- extendedWaitUntil:
    visible:
      id: "assistant-message"
    timeout: 60000
- evalScript: "${console.log('TEXT_GEN - Assistant responded')}"
- takeScreenshot: 03-first-response

# ==============================
# Verify generation metadata is shown
# ==============================
- evalScript: "${console.log('TEXT_GEN - Check generation meta')}"
- assertVisible:
    id: "generation-meta"
- takeScreenshot: 04-generation-meta

# ==============================
# Test 2: Message actions - long press to show action menu
# ==============================
- evalScript: "${console.log('TEXT_GEN - Test action menu')}"
- longPressOn:
    id: "assistant-message"

- extendedWaitUntil:
    visible:
      id: "action-menu"
    timeout: 5000
- takeScreenshot: 05-action-menu

# Verify copy action exists
- assertVisible:
    id: "action-copy"

# Verify retry action exists
- assertVisible:
    id: "action-retry"

# Dismiss action menu
- tapOn:
    id: "action-copy"
- evalScript: "${console.log('TEXT_GEN - Copied message')}"

# ==============================
# Test 3: Multi-turn conversation
# ==============================
- evalScript: "${console.log('TEXT_GEN - Send second message')}"
- tapOn:
    id: "chat-input"
- inputText: "Now say the word HELLO"
- hideKeyboard

- tapOn:
    id: "send-button"

# Wait for second response
- extendedWaitUntil:
    visible:
      id: "message-text"
    timeout: 60000
- evalScript: "${console.log('TEXT_GEN - Second response received')}"
- takeScreenshot: 06-multi-turn

# ==============================
# Test 4: Chat settings accessible
# ==============================
- evalScript: "${console.log('TEXT_GEN - Open settings')}"
- tapOn:
    id: "chat-settings-icon"

# Verify settings modal appears with generation options
- extendedWaitUntil:
    visible:
      text: "Temperature"
    timeout: 5000
- evalScript: "${console.log('TEXT_GEN - Settings modal shown')}"
- takeScreenshot: 07-settings

# Close settings
- tapOn:
    text: "Done"
- evalScript: "${console.log('TEXT_GEN - Settings closed')}"

# ==============================
# Verify input ready for next message
# ==============================
- assertVisible:
    id: "chat-input"
- assertVisible:
    id: "document-picker-button"

- evalScript: "${console.log('TEXT_GEN - PASSED')}"
- takeScreenshot: 99-complete
